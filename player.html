<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Player ‚Äî FossBOX</title>
    <script src="assets/js/config.js"></script>
    <style>
        body{background:#0f0f0f url('assets/site-bg.jpg') center center fixed;background-size:cover;color:#ddd;font-family:system-ui,Segoe UI,Roboto,Arial;margin:0;padding:20px}
        .container{max-width:1400px;margin:24px auto;background:rgba(20, 20, 20, 0.75);border:1px solid rgba(255,255,255,0.03);border-radius:8px;padding:20px}
        
        /* Mobile background */
        @media (max-width: 768px) {
            body{background:#0f0f0f url('assets/m-site-bg.jpg') center center fixed;background-size:cover;}
        }
        
        /* Main layout - centered player with controls below */
        .player-layout{display:flex;flex-direction:column;gap:24px;align-items:center;min-height:600px}
        
        /* Video player section - centered with relative positioning for dropdown */
        .video-section{width:100%;max-width:1000px;min-width:0;position:relative}
        
        /* Content Header - Title, Rating, Description */
        .content-header{background:rgba(26,26,26,0.85);border:1px solid #333;border-radius:8px;padding:20px;margin-bottom:20px;backdrop-filter:blur(10px)}
        .content-title{font-size:2.2rem;font-weight:800;color:#fff;margin:0 0 8px 0;line-height:1.2}
        .content-meta{display:flex;align-items:center;gap:20px;margin-bottom:15px;flex-wrap:wrap}
        .content-year{color:#aaa;font-size:1.1rem;font-weight:500}
        .content-rating{display:flex;align-items:center;gap:8px;background:rgba(0,188,212,0.15);padding:6px 12px;border-radius:6px;border:1px solid rgba(0,188,212,0.3)}
        .rating-star{color:#ffd700;font-size:1.2rem}
        .rating-value{color:#00bcd4;font-weight:700;font-size:1.1rem}
        .rating-max{color:#aaa;font-size:0.9rem}
        .content-description{color:#ddd;line-height:1.7;font-size:0.95rem;margin:0}
        
        .player-container{width:100%;background:#000;border-radius:8px;overflow:hidden;border:1px solid #333;aspect-ratio:16/9}
        .player-container iframe{width:100%;height:100%;border:none;background:#000}
        .embed-placeholder{background:#000;border:1px solid #333;padding:40px;border-radius:8px;color:#9fd;height:100%;display:flex;align-items:center;justify-content:center;text-align:center;flex-direction:column}
        
        /* Floating Server Dropdown Button */
        .server-dropdown-wrapper{position:absolute;top:0;left:50%;transform:translateX(-50%);z-index:100;width:auto}
        .server-dropdown-btn{background:rgba(0,188,212,0.95);color:#000;border:none;padding:12px 24px;border-radius:0 0 8px 8px;cursor:pointer;font-weight:700;font-size:0.95rem;box-shadow:0 4px 12px rgba(0,188,212,0.4);transition:all 0.2s;display:flex;align-items:center;gap:8px;min-width:180px;justify-content:space-between;backdrop-filter:blur(10px)}
        .server-dropdown-btn:hover{background:rgba(0,188,212,1);box-shadow:0 6px 16px rgba(0,188,212,0.6);transform:translateY(2px)}
        .server-dropdown-btn.open{border-radius:0 0 0 0;box-shadow:0 8px 20px rgba(0,188,212,0.5)}
        .dropdown-arrow{transition:transform 0.2s;font-size:0.8rem}
        .server-dropdown-btn.open .dropdown-arrow{transform:rotate(180deg)}
        .server-dropdown-menu{position:absolute;top:100%;left:0;right:0;background:rgba(26,26,26,0.98);border:1px solid #00bcd4;border-top:none;border-radius:0 0 8px 8px;max-height:0;overflow:hidden;transition:max-height 0.3s ease;box-shadow:0 8px 20px rgba(0,0,0,0.6);backdrop-filter:blur(10px)}
        .server-dropdown-menu.open{max-height:400px;overflow-y:auto}
        .server-dropdown-item{padding:12px 20px;color:#ddd;cursor:pointer;transition:all 0.2s;border-bottom:1px solid #333;font-size:0.9rem;background:transparent}
        .server-dropdown-item:last-child{border-bottom:none}
        .server-dropdown-item:hover{background:rgba(0,188,212,0.15);color:#00bcd4;padding-left:24px}
        .server-dropdown-item.active{background:rgba(0,188,212,0.25);color:#00bcd4;font-weight:600;border-left:3px solid #00bcd4}
        
        /* Custom Video Controls Bar */
        .video-controls-bar{position:absolute;bottom:0;left:0;right:0;background:linear-gradient(to top, rgba(0,0,0,0.95), rgba(0,0,0,0.85));padding:15px 20px;border-radius:0 0 8px 8px;z-index:50;display:flex;flex-direction:column;gap:12px;opacity:0;transition:opacity 0.3s ease;pointer-events:none}
        .video-section:hover .video-controls-bar{opacity:1;pointer-events:all}
        .video-controls-bar.always-show{opacity:1;pointer-events:all}
        
        /* Progress bar */
        .progress-container{width:100%;height:6px;background:rgba(255,255,255,0.2);border-radius:3px;cursor:pointer;position:relative}
        .progress-bar{height:100%;background:#00bcd4;border-radius:3px;width:0%;transition:width 0.1s linear}
        .progress-handle{position:absolute;top:50%;right:0;transform:translate(50%, -50%);width:14px;height:14px;background:#00bcd4;border-radius:50%;box-shadow:0 0 4px rgba(0,188,212,0.6);opacity:0;transition:opacity 0.2s}
        .progress-container:hover .progress-handle{opacity:1}
        
        /* Controls buttons row */
        .controls-buttons-row{display:flex;align-items:center;justify-content:space-between;gap:15px}
        .controls-left{display:flex;align-items:center;gap:12px}
        .controls-center{display:flex;align-items:center;gap:8px}
        .controls-right{display:flex;align-items:center;gap:12px}
        
        /* Control buttons */
        .control-btn{background:transparent;border:none;color:#fff;cursor:pointer;padding:8px;border-radius:4px;transition:all 0.2s;display:flex;align-items:center;justify-content:center;font-size:1.1rem;min-width:36px;height:36px}
        .control-btn:hover{background:rgba(255,255,255,0.1);transform:scale(1.1)}
        .control-btn:active{transform:scale(0.95)}
        .control-btn.primary{background:rgba(0,188,212,0.2);color:#00bcd4}
        .control-btn.primary:hover{background:rgba(0,188,212,0.3)}
        .control-btn:disabled{opacity:0.3;cursor:not-allowed}
        .control-btn:disabled:hover{background:transparent;transform:none}
        
        /* Time display */
        .time-display{color:#ddd;font-size:0.85rem;font-weight:500;white-space:nowrap;font-family:'Courier New',monospace}
        
        /* Controls section - positioned below player */
        .controls-section{width:100%;max-width:1000px;min-width:320px;background:#1a1a1a;border-radius:8px;padding:20px;border:1px solid #333;background-size:cover;background-position:center;background-repeat:no-repeat;position:relative}
        .controls-section::before{content:'';position:absolute;top:0;left:0;right:0;bottom:0;background:rgba(26,26,26,0.85);border-radius:8px;z-index:1}
        .controls-section > *{position:relative;z-index:2}
        
        /* Title and meta info */
        .title{font-size:1.8rem;font-weight:800;color:#fff;margin-bottom:8px;line-height:1.2}
        .subtitle{color:#aaa;margin-bottom:20px;line-height:1.4}
        
        /* Server selection - HIDDEN (now using dropdown) */
        .server-selector{display:none !important}
        .server-selector h4{color:#fff;margin:0 0 12px 0;font-size:1.1rem}
        .server-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px}
        .server-btn{background:#2a2a2a;color:#ddd;border:1px solid #444;padding:10px;border-radius:6px;cursor:pointer;transition:all 0.2s;text-align:center;font-size:0.9rem}
        .server-btn:hover{background:#333;color:#fff;transform:translateY(-1px)}
        .server-btn.active{background:#00bcd4;color:#000;border-color:#00bcd4;font-weight:600}
        
        /* TV Show Controls */
        .tv-controls{margin-bottom:20px}
        .tv-controls h4{color:#fff;margin:0 0 12px 0;font-size:1.1rem}
        .season-selector{margin-bottom:12px}
        .season-dropdown{width:100%;background:#2a2a2a;color:#ddd;border:1px solid #444;padding:10px;border-radius:6px;font-size:0.9rem}
        
        /* Episode list */
        .episodes-list{max-height:300px;overflow-y:auto;border:1px solid #333;border-radius:6px;background:#222}
        .episode-item{padding:12px;border-bottom:1px solid #333;cursor:pointer;transition:background 0.2s;display:flex;align-items:center;gap:10px}
        .episode-item:hover{background:#2a2a2a}
        .episode-item:last-child{border-bottom:none}
        .episode-item.current{background:#00bcd4;color:#000}
        .episode-number{background:#444;color:#fff;padding:4px 8px;border-radius:4px;font-size:0.8rem;font-weight:600;min-width:30px;text-align:center}
        .episode-item.current .episode-number{background:#fff;color:#00bcd4}
        .episode-title{flex:1;font-size:0.9rem}
        
        /* Player controls */
        .player-controls{margin-bottom:20px}
        .player-controls h4{color:#fff;margin:0 0 12px 0;font-size:1.1rem}
        .controls-grid{display:grid;gap:10px}
        .control-row{display:flex;gap:10px;align-items:center}
        .control-row select{flex:1;background:#2a2a2a;color:#ddd;border:1px solid #444;padding:8px;border-radius:4px}
        .control-row label{display:flex;align-items:center;gap:6px;font-size:0.9rem;color:#aaa}
        
        /* Back button */
        .back-button{width:100%;background:#333;color:#ddd;border:1px solid #555;padding:12px;border-radius:6px;cursor:pointer;margin-top:20px;font-size:0.9rem}
        .back-button:hover{background:#444;color:#fff}
        
        .loading{color:#00bcd4;padding:20px}
        
        /* Scrollbar styling */
        .episodes-list::-webkit-scrollbar{width:8px}
        .episodes-list::-webkit-scrollbar-track{background:#1a1a1a}
        .episodes-list::-webkit-scrollbar-thumb{background:#444;border-radius:4px}
        .episodes-list::-webkit-scrollbar-thumb:hover{background:#555}
        
        /* Navigation hover effects */
        .site-nav a:hover{background:#00bcd4 !important;color:#000 !important;transform:translateY(-2px)}
        
        /* Advanced Search Link */
        .advanced-search-link{position:absolute;top:20px;right:340px;z-index:15;text-align:center;line-height:1.2}
        .advanced-search-link a{color:#00bcd4;text-decoration:none;font-size:0.75rem;font-weight:600;transition:all 0.2s;display:block;padding:6px 10px;border:1px solid rgba(0,188,212,0.3);border-radius:4px;background:rgba(0,188,212,0.1);backdrop-filter:blur(10px)}
        .advanced-search-link a:hover{color:#fff;background:rgba(0,188,212,0.3);border-color:#00bcd4;transform:scale(1.05)}
        
        @media (max-width: 1024px) {
            .video-section{max-width:100%}
            .controls-section{max-width:100%;min-width:0}
            .server-grid{grid-template-columns:1fr}
        }
        
        @media (max-width: 768px) {
            .container{padding:15px}
            .player-layout{gap:15px}
            .title{font-size:1.5rem}
            .video-section{max-width:100%}
            .controls-section{max-width:100%}
        }
    </style>
</head>
<body>
  <!-- Header -->
  <header class="site-header" style="height: 120px; background: linear-gradient(to bottom, rgba(26, 26, 26, 0.75), rgba(60, 60, 60, 0.75), rgba(26, 26, 26, 0.75)); position: relative; margin-bottom: 20px; display: flex; align-items: center; justify-content: center;">
    <div class="logo" style="display: flex; align-items: center; position: absolute; left: 80px; top: 50%; transform: translateY(-50%); z-index: 10;">
      <img src="assets/site-logo.png" alt="FossBOX Logo" style="height: 100px; margin-right: 20px; opacity: 0.5; box-shadow: 0 8px 16px rgba(0,0,0,0.6), 0 4px 8px rgba(0,0,0,0.4);">
      <span style="font-size: 3rem; font-weight: 800; color: #00bcd4; text-shadow: 0 4px 8px rgba(0,0,0,0.8);">FossBOX</span>
    </div>
    
    <!-- Header Search -->
    <div class="header-search" style="position: absolute; top: 20px; right: 20px; z-index: 15; width: 300px;">
      <form class="search-form" id="headerSearchForm" style="display: flex; background: rgba(0, 0, 0, 0.8); border: 1px solid #333; border-radius: 6px; overflow: hidden; backdrop-filter: blur(10px);">
        <input type="text" id="headerSearchInput" placeholder="Search movies & TV shows..." autocomplete="off" style="flex: 1; padding: 12px 16px; background: transparent; border: none; color: #ddd; font-size: 0.9rem; outline: none;">
        <button type="submit" class="search-btn" style="background: #00bcd4; border: none; padding: 12px 16px; color: #000; cursor: pointer; font-size: 1rem; transition: all 0.2s ease;">üîç</button>
      </form>
      <div class="search-results" id="headerSearchResults" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: rgba(0, 0, 0, 0.95); border: 1px solid #333; border-top: none; border-radius: 0 0 6px 6px; max-height: 400px; overflow-y: auto; backdrop-filter: blur(10px); z-index: 20;"></div>
    </div>
    
    <!-- Advanced Search Link -->
    <div class="advanced-search-link">
      <a href="#" id="advancedSearchLink" title="Advanced Search Options">Advanced<br>Search<br>Filters...</a>
    </div>
  </header>

<div class="container" id="app">
    <!-- Breadcrumb -->
    <nav class="breadcrumb" aria-label="Page location" style="margin-bottom: 20px; padding: 10px 0; color: #aaa; font-size: 0.9rem;">
      <a href="index.html" style="color: #00bcd4; text-decoration: none;">Home</a> 
      <span style="margin: 0 8px; color: #666;">‚Ä∫</span>
      <span style="color: #ddd;" id="breadcrumb-title">Player</span>
    </nav>

    <div class="player-layout">
        <!-- Left Side - Video Player -->
        <div class="video-section">
            <!-- Content Header -->
            <div class="content-header" id="contentHeader" style="display:none;">
                <h1 class="content-title" id="contentTitle">Loading...</h1>
                <div class="content-meta">
                    <span class="content-year" id="contentYear">----</span>
                    <div class="content-rating" id="contentRatingBox" style="display:none;">
                        <span class="rating-star">‚≠ê</span>
                        <span class="rating-value" id="contentRating">0.0</span>
                        <span class="rating-max">/10</span>
                    </div>
                </div>
                <p class="content-description" id="contentDescription"></p>
            </div>
            
            <!-- Floating Server Dropdown -->
            <div class="server-dropdown-wrapper" id="serverDropdownWrapper" style="display:none;">
                <button class="server-dropdown-btn" id="serverDropdownBtn">
                    <span id="currentServerName">VidSrc Embed</span>
                    <span class="dropdown-arrow">‚ñº</span>
                </button>
                <div class="server-dropdown-menu" id="serverDropdownMenu">
                    <div class="server-dropdown-item active" data-server="vidsrc-embed.ru">VidSrc Embed</div>
                    <div class="server-dropdown-item" data-server="vidsrcme.ru">VidSrc ME</div>
                    <div class="server-dropdown-item" data-server="vidsrc-me.ru">VidSrc Alt</div>
                    <div class="server-dropdown-item" data-server="vsrc.su">VSrc</div>
                    <div class="server-dropdown-item" data-server="vidsrc-embed.su">VidSrc SU</div>
                    <div class="server-dropdown-item" data-server="vidsrcme.su">VidSrc ME SU</div>
                    <div class="server-dropdown-item" data-server="autoembed.cc">AutoEmbed</div>
                    <div class="server-dropdown-item" data-server="vidlink.pro">VidLink</div>
                </div>
            </div>
            
            <div class="player-container" id="playerContainer">
                <div class="embed-placeholder" id="embedArea">
                    <div class="loading">üé¨ Select a server to start watching</div>
                    <div style="color:#aaa;font-size:0.9em;margin-top:10px;">Choose a server from the controls to load the video player</div>
                </div>
            </div>
            
            <!-- Custom Video Controls Bar -->
            <div class="video-controls-bar" id="videoControlsBar">
                <!-- Progress Bar -->
                <div class="progress-container" id="progressContainer">
                    <div class="progress-bar" id="progressBar">
                        <div class="progress-handle"></div>
                    </div>
                </div>
                
                <!-- Control Buttons -->
                <div class="controls-buttons-row">
                    <div class="controls-left">
                        <button class="control-btn" id="prevEpisodeBtn" title="Previous Episode" disabled>
                            <span>‚èÆÔ∏è</span>
                        </button>
                        <button class="control-btn" id="rewind10Btn" title="Rewind 10 seconds">
                            <span>‚è™</span>
                        </button>
                    </div>
                    
                    <div class="controls-center">
                        <button class="control-btn primary" id="playPauseBtn" title="Play/Pause">
                            <span id="playPauseIcon">‚ñ∂Ô∏è</span>
                        </button>
                    </div>
                    
                    <div class="controls-right">
                        <button class="control-btn" id="forward10Btn" title="Fast forward 10 seconds">
                            <span>‚è©</span>
                        </button>
                        <button class="control-btn" id="nextEpisodeBtn" title="Next Episode" disabled>
                            <span>‚è≠Ô∏è</span>
                        </button>
                        <div class="time-display" id="timeDisplay">
                            <span id="currentTime">0:00</span> / <span id="totalTime">0:00</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Side - Controls and Info -->
        <div class="controls-section" id="controlsSection">
            <!-- Title and Info -->
            <div id="title" class="title">Loading...</div>
            <div id="subtitle" class="subtitle">Please wait...</div>
            
            <!-- Server Selection -->
            <div class="server-selector" id="serverSelector" style="display:none;">
                <h4>Select Server</h4>
                <div class="server-grid">
                    <button class="server-btn active" data-server="vidsrc-embed.ru">VidSrc Embed</button>
                    <button class="server-btn" data-server="vidsrcme.ru">VidSrc ME</button>
                    <button class="server-btn" data-server="vidsrc-me.ru">VidSrc Alt</button>
                    <button class="server-btn" data-server="vsrc.su">VSrc</button>
                    <button class="server-btn" data-server="vidsrc-embed.su">VidSrc SU</button>
                    <button class="server-btn" data-server="vidsrcme.su">VidSrc ME SU</button>
                    <button class="server-btn" data-server="autoembed.cc">AutoEmbed</button>
                    <button class="server-btn" data-server="vidlink.pro">VidLink</button>
                </div>
            </div>

            <!-- TV Show Controls -->
            <div class="tv-controls" id="tvControls" style="display:none;">
                <h4>Episodes</h4>
                <div class="season-selector">
                    <select class="season-dropdown" id="seasonSelect">
                        <option value="">Loading seasons...</option>
                    </select>
                </div>
                <div class="episodes-list" id="episodesList">
                    <div style="padding:20px;text-align:center;color:#aaa;">Select a season to view episodes</div>
                </div>
            </div>

            <!-- Player Controls -->
            <div class="player-controls" id="playerControls" style="display:none;">
                <h4>Player Settings</h4>
                <div class="controls-grid">
                    <div class="control-row">
                        <label for="qualitySelect" style="color: #ddd; font-size: 0.9rem; margin-bottom: 4px; display: block;">Video Quality</label>
                        <select id="qualitySelect" style="width: 100%; background: #2a2a2a; color: #ddd; border: 1px solid #444; padding: 8px; border-radius: 4px; margin-bottom: 12px;">
                            <option value="auto">Auto (Best Available)</option>
                            <option value="1080">1080p (Full HD)</option>
                            <option value="720">720p (HD)</option>
                            <option value="480">480p (SD)</option>
                            <option value="360">360p</option>
                        </select>
                    </div>
                    <div class="control-row">
                        <label for="languageSelect" style="color: #ddd; font-size: 0.9rem; margin-bottom: 4px; display: block;">Language</label>
                        <select id="languageSelect" style="width: 100%; background: #2a2a2a; color: #ddd; border: 1px solid #444; padding: 8px; border-radius: 4px;">
                            <option value="">Default Language</option>
                            <option value="en">English</option>
                            <option value="es">Spanish</option>
                            <option value="fr">French</option>
                            <option value="de">German</option>
                            <option value="it">Italian</option>
                            <option value="pt">Portuguese</option>
                            <option value="ru">Russian</option>
                            <option value="ja">Japanese</option>
                            <option value="ko">Korean</option>
                        </select>
                    </div>
                    <div class="control-row">
                        <label>
                            <input type="checkbox" id="autoplayCheck" checked> Autoplay
                        </label>
                    </div>
                </div>
            </div>

            <!-- Back Navigation -->
            <button class="back-button" onclick="history.back()">
                ‚Üê Back to Browse
            </button>
        </div>
    </div>
</div>

<script>
class VideoPlayer {
    constructor() {
        this.servers = [
            { name: 'VidSrc Embed', domain: 'vidsrc-embed.ru', active: true },
            { name: 'VidSrc ME', domain: 'vidsrcme.ru', active: true },
            { name: 'VidSrc Alt', domain: 'vidsrc-me.ru', active: true },
            { name: 'VSrc', domain: 'vsrc.su', active: true },
            { name: 'VidSrc SU', domain: 'vidsrc-embed.su', active: true },
            { name: 'VidSrc ME SU', domain: 'vidsrcme.su', active: true },
            { name: 'AutoEmbed', domain: 'autoembed.cc', active: true },
            { name: 'VidLink', domain: 'vidlink.pro', active: true }
        ];
        
        this.currentServer = 'vidsrc-embed.ru';
        this.movieData = null;
        this.seasonsData = null;
        this.currentSeason = 1;
        this.currentEpisode = 1;
        this.preferredQuality = 'auto';
        this.availableQualities = ['1080', '720', '480', '360'];
        this.videoIframe = null;
        this.isPlaying = false;
        this.currentTime = 0;
        this.duration = 0;
        this.init();
    }

    getUrlParams() {
        const params = new URLSearchParams(window.location.search);
        return {
            tmdbId: params.get('tmdb') || params.get('id') || params.get('video'),
            imdbId: params.get('imdb'),
            type: params.get('type') || 'movie',
            season: parseInt(params.get('season') || params.get('s')) || 1,
            episode: parseInt(params.get('episode') || params.get('e')) || 1,
            title: params.get('title')
        };
    }

    async init() {
        const params = this.getUrlParams();
        
        if (!params.tmdbId && !params.imdbId) {
            this.showError('No movie/TV show ID provided');
            return;
        }

        // Set current season/episode from URL
        this.currentSeason = params.season;
        this.currentEpisode = params.episode;

        try {
            await this.loadMovieData(params.tmdbId, params.type, params.imdbId);
            
            // Load TV show seasons if it's a TV show
            if (this.movieData.type === 'tv') {
                await this.loadSeasons(params.tmdbId);
            }
            
            this.setupUI();
            
            // Setup TV controls if it's a TV show
            if (this.movieData.type === 'tv') {
                this.setupTVControls();
            }
            
        } catch (error) {
            console.error('Failed to initialize player:', error);
            this.showError('Failed to load movie data');
        }
    }

    async loadMovieData(tmdbId, type = 'movie', imdbId = null) {
        // Try to get API key from config
        const API_KEY = window.TMDB_API_KEY || window.FossBOXConfig?.api?.tmdb?.key;
        
        if (!API_KEY) {
            console.error('No TMDb API key found');
            // Use fallback data if no API key
            this.movieData = {
                id: tmdbId,
                imdb_id: imdbId,
                title: `${type === 'movie' ? 'Movie' : 'TV Show'} ID: ${tmdbId}`,
                name: `${type === 'movie' ? 'Movie' : 'TV Show'} ID: ${tmdbId}`,
                overview: 'Loading movie information...',
                poster_path: null,
                release_date: '2024',
                first_air_date: '2024',
                type: type,
                number_of_seasons: type === 'tv' ? 3 : 0
            };
            return;
        }

        try {
            const url = `https://api.themoviedb.org/3/${type}/${tmdbId}?api_key=${API_KEY}&append_to_response=external_ids`;
            console.log('Loading movie data from:', url);
            const response = await fetch(url);
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            this.movieData = await response.json();
            this.movieData.type = type;
            
            console.log('Loaded movie data:', this.movieData);
            
            // Get IMDB ID if not provided
            if (!imdbId && this.movieData.external_ids?.imdb_id) {
                this.movieData.imdb_id = this.movieData.external_ids.imdb_id;
            } else if (imdbId) {
                this.movieData.imdb_id = imdbId;
            }
            
        } catch (error) {
            console.error('Failed to fetch movie data:', error);
            // Better fallback data with actual content name attempt
            this.movieData = {
                id: tmdbId,
                imdb_id: imdbId,
                title: `Content ${tmdbId}`,
                name: `Content ${tmdbId}`,
                overview: 'Could not load detailed information.',
                poster_path: null,
                release_date: '2024',
                first_air_date: '2024',
                type: type,
                number_of_seasons: type === 'tv' ? 3 : 0
            };
        }
    }

    async loadSeasons(tmdbId) {
        const API_KEY = window.TMDB_API_KEY || window.FossBOXConfig?.api?.tmdb?.key;
        
        if (!API_KEY) {
            console.warn('No TMDb API key found, using fallback seasons data');
            // Create fallback seasons data
            this.seasonsData = [];
            const numSeasons = this.movieData.number_of_seasons || 3;
            for (let i = 1; i <= numSeasons; i++) {
                const episodes = [];
                for (let j = 1; j <= 12; j++) {
                    episodes.push({
                        episode_number: j,
                        name: `Episode ${j}`,
                        overview: `Episode ${j} description.`
                    });
                }
                this.seasonsData.push({
                    season_number: i,
                    name: `Season ${i}`,
                    episode_count: 12,
                    episodes: episodes
                });
            }
            console.log('Created fallback seasons:', this.seasonsData);
            return;
        }

        try {
            // Load all seasons
            this.seasonsData = [];
            const numSeasons = this.movieData.number_of_seasons || 3;
            console.log(`Loading ${numSeasons} seasons for TMDb ID: ${tmdbId}`);
            
            for (let seasonNum = 1; seasonNum <= numSeasons; seasonNum++) {
                try {
                    const seasonUrl = `https://api.themoviedb.org/3/tv/${tmdbId}/season/${seasonNum}?api_key=${API_KEY}`;
                    console.log(`Loading season ${seasonNum} from:`, seasonUrl);
                    const seasonResponse = await fetch(seasonUrl);
                    
                    if (seasonResponse.ok) {
                        const seasonData = await seasonResponse.json();
                        console.log(`Loaded season ${seasonNum}:`, seasonData);
                        this.seasonsData.push(seasonData);
                    } else {
                        console.warn(`Failed to load season ${seasonNum}, using fallback`);
                        // Add fallback season
                        const episodes = [];
                        for (let j = 1; j <= 12; j++) {
                            episodes.push({
                                episode_number: j,
                                name: `Episode ${j}`,
                                overview: `Episode ${j} description.`
                            });
                        }
                        this.seasonsData.push({
                            season_number: seasonNum,
                            name: `Season ${seasonNum}`,
                            episode_count: 12,
                            episodes: episodes
                        });
                    }
                } catch (error) {
                    console.error(`Failed to load season ${seasonNum}:`, error);
                    // Add fallback season
                    const episodes = [];
                    for (let j = 1; j <= 12; j++) {
                        episodes.push({
                            episode_number: j,
                            name: `Episode ${j}`,
                            overview: `Episode ${j} description.`
                        });
                    }
                    this.seasonsData.push({
                        season_number: seasonNum,
                        name: `Season ${seasonNum}`,
                        episode_count: 12,
                        episodes: episodes
                    });
                }
            }
            
            console.log('Final seasons data:', this.seasonsData);
            
        } catch (error) {
            console.error('Failed to load seasons:', error);
            // Better fallback with multiple seasons
            this.seasonsData = [];
            for (let i = 1; i <= 3; i++) {
                const episodes = [];
                for (let j = 1; j <= 12; j++) {
                    episodes.push({
                        episode_number: j,
                        name: `Episode ${j}`,
                        overview: `Episode ${j} description.`
                    });
                }
                this.seasonsData.push({
                    season_number: i,
                    name: `Season ${i}`,
                    episode_count: 12,
                    episodes: episodes
                });
            }
        }
    }

    setupUI() {
        const titleEl = document.getElementById('title');
        const subtitleEl = document.getElementById('subtitle');
        const controlsSection = document.getElementById('controlsSection');
        const serverSelector = document.getElementById('serverSelector');
        const playerControls = document.getElementById('playerControls');
        const tvControls = document.getElementById('tvControls');
        const breadcrumbTitle = document.getElementById('breadcrumb-title');
        
        // New content header elements
        const contentHeader = document.getElementById('contentHeader');
        const contentTitle = document.getElementById('contentTitle');
        const contentYear = document.getElementById('contentYear');
        const contentRating = document.getElementById('contentRating');
        const contentRatingBox = document.getElementById('contentRatingBox');
        const contentDescription = document.getElementById('contentDescription');

        // Set title and info
        const mainTitle = this.movieData.title || this.movieData.name || 'Unknown Title';
        const year = this.movieData.release_date || this.movieData.first_air_date;
        const yearText = year ? year.split('-')[0] : 'Unknown';
        
        // Update content header
        if (contentTitle) {
            contentTitle.textContent = mainTitle + (yearText !== 'Unknown' ? ` (${yearText})` : '');
        }
        
        if (contentYear) {
            let yearDisplay = yearText;
            if (this.movieData.type === 'tv') {
                yearDisplay += ` ‚Ä¢ S${this.currentSeason}E${this.currentEpisode}`;
            }
            contentYear.textContent = yearDisplay;
        }
        
        // Update rating
        if (this.movieData.vote_average && contentRating) {
            const rating = this.movieData.vote_average.toFixed(1);
            contentRating.textContent = rating;
            if (contentRatingBox) {
                contentRatingBox.style.display = 'flex';
            }
        }
        
        // Update description
        if (this.movieData.overview && contentDescription) {
            contentDescription.textContent = this.movieData.overview;
        }
        
        // Show content header
        if (contentHeader) {
            contentHeader.style.display = 'block';
        }
        
        // Update old elements for controls section
        titleEl.textContent = mainTitle;
        
        // Update breadcrumb
        if (breadcrumbTitle) {
            breadcrumbTitle.textContent = mainTitle;
        }

        // Set background image for controls section
        if (this.movieData.poster_path) {
            const posterUrl = `https://image.tmdb.org/t/p/w500${this.movieData.poster_path}`;
            controlsSection.style.backgroundImage = `url('${posterUrl}')`;
        }
        
        let subtitleText = `${this.movieData.type === 'movie' ? 'Movie' : 'TV Show'} ‚Ä¢ ${yearText}`;
        
        // Add season/episode info for TV shows
        if (this.movieData.type === 'tv') {
            subtitleText += ` ‚Ä¢ S${this.currentSeason}E${this.currentEpisode}`;
        }
        
        subtitleText += this.movieData.overview ? `<br><small style="color:#aaa;">${this.movieData.overview.substring(0, 120)}...</small>` : '';
        
        subtitleEl.innerHTML = subtitleText;

        // Show controls
        serverSelector.style.display = 'block';
        playerControls.style.display = 'block';
        
        // Show TV controls for TV shows
        if (this.movieData.type === 'tv') {
            tvControls.style.display = 'block';
        }

        // Setup server buttons
        this.setupServerButtons();
        
        // Setup quality controls
        this.setupQualityControls();
        
        // Load default server
        this.loadServer(this.currentServer);
        
        // Setup video controls
        this.setupVideoControls();
    }

    setupVideoControls() {
        const playPauseBtn = document.getElementById('playPauseBtn');
        const playPauseIcon = document.getElementById('playPauseIcon');
        const rewind10Btn = document.getElementById('rewind10Btn');
        const forward10Btn = document.getElementById('forward10Btn');
        const prevEpisodeBtn = document.getElementById('prevEpisodeBtn');
        const nextEpisodeBtn = document.getElementById('nextEpisodeBtn');
        const progressContainer = document.getElementById('progressContainer');
        const progressBar = document.getElementById('progressBar');
        const currentTimeEl = document.getElementById('currentTime');
        const totalTimeEl = document.getElementById('totalTime');
        
        // Play/Pause button
        playPauseBtn?.addEventListener('click', () => {
            this.togglePlayPause();
        });
        
        // Rewind 10 seconds
        rewind10Btn?.addEventListener('click', () => {
            this.skipTime(-10);
        });
        
        // Forward 10 seconds
        forward10Btn?.addEventListener('click', () => {
            this.skipTime(10);
        });
        
        // Previous episode
        prevEpisodeBtn?.addEventListener('click', () => {
            this.goToPreviousEpisode();
        });
        
        // Next episode
        nextEpisodeBtn?.addEventListener('click', () => {
            this.goToNextEpisode();
        });
        
        // Progress bar click
        progressContainer?.addEventListener('click', (e) => {
            const rect = progressContainer.getBoundingClientRect();
            const percent = (e.clientX - rect.left) / rect.width;
            this.seekToPercent(percent);
        });
        
        // Update episode navigation buttons
        this.updateEpisodeNavButtons();
        
        // Start time update interval
        this.startTimeTracking();
    }
    
    togglePlayPause() {
        const playPauseIcon = document.getElementById('playPauseIcon');
        
        // Try to send message to iframe
        if (this.videoIframe && this.videoIframe.contentWindow) {
            try {
                this.videoIframe.contentWindow.postMessage({
                    action: this.isPlaying ? 'pause' : 'play'
                }, '*');
                
                this.isPlaying = !this.isPlaying;
                if (playPauseIcon) {
                    playPauseIcon.textContent = this.isPlaying ? '‚è∏Ô∏è' : '‚ñ∂Ô∏è';
                }
            } catch (error) {
                console.log('Cannot control embedded player directly');
            }
        }
    }
    
    skipTime(seconds) {
        // Try to send message to iframe
        if (this.videoIframe && this.videoIframe.contentWindow) {
            try {
                this.videoIframe.contentWindow.postMessage({
                    action: 'seek',
                    time: this.currentTime + seconds
                }, '*');
                
                this.currentTime = Math.max(0, Math.min(this.duration, this.currentTime + seconds));
                this.updateTimeDisplay();
            } catch (error) {
                console.log('Cannot control embedded player directly');
            }
        }
    }
    
    seekToPercent(percent) {
        if (this.duration > 0) {
            const seekTime = this.duration * percent;
            
            if (this.videoIframe && this.videoIframe.contentWindow) {
                try {
                    this.videoIframe.contentWindow.postMessage({
                        action: 'seek',
                        time: seekTime
                    }, '*');
                    
                    this.currentTime = seekTime;
                    this.updateTimeDisplay();
                } catch (error) {
                    console.log('Cannot control embedded player directly');
                }
            }
        }
    }
    
    goToPreviousEpisode() {
        if (this.movieData.type !== 'tv') return;
        
        const currentSeasonData = this.seasonsData.find(s => s.season_number === this.currentSeason);
        
        if (this.currentEpisode > 1) {
            // Go to previous episode in same season
            this.currentEpisode--;
            this.updateURL();
            this.updateSubtitle();
            this.loadServer(this.currentServer);
            this.updateEpisodesList();
            this.updateEpisodeNavButtons();
        } else if (this.currentSeason > 1) {
            // Go to last episode of previous season
            this.currentSeason--;
            const prevSeasonData = this.seasonsData.find(s => s.season_number === this.currentSeason);
            this.currentEpisode = prevSeasonData?.episode_count || 12;
            this.updateURL();
            this.updateSubtitle();
            this.loadServer(this.currentServer);
            this.updateEpisodesList();
            this.updateEpisodeNavButtons();
            
            // Update season selector
            const seasonSelect = document.getElementById('seasonSelect');
            if (seasonSelect) seasonSelect.value = this.currentSeason;
        }
    }
    
    goToNextEpisode() {
        if (this.movieData.type !== 'tv') return;
        
        const currentSeasonData = this.seasonsData.find(s => s.season_number === this.currentSeason);
        const maxEpisodes = currentSeasonData?.episode_count || 12;
        
        if (this.currentEpisode < maxEpisodes) {
            // Go to next episode in same season
            this.currentEpisode++;
            this.updateURL();
            this.updateSubtitle();
            this.loadServer(this.currentServer);
            this.updateEpisodesList();
            this.updateEpisodeNavButtons();
        } else if (this.currentSeason < this.seasonsData.length) {
            // Go to first episode of next season
            this.currentSeason++;
            this.currentEpisode = 1;
            this.updateURL();
            this.updateSubtitle();
            this.loadServer(this.currentServer);
            this.updateEpisodesList();
            this.updateEpisodeNavButtons();
            
            // Update season selector
            const seasonSelect = document.getElementById('seasonSelect');
            if (seasonSelect) seasonSelect.value = this.currentSeason;
        }
    }
    
    updateEpisodeNavButtons() {
        const prevEpisodeBtn = document.getElementById('prevEpisodeBtn');
        const nextEpisodeBtn = document.getElementById('nextEpisodeBtn');
        
        if (this.movieData.type !== 'tv') {
            // Disable for movies
            if (prevEpisodeBtn) prevEpisodeBtn.disabled = true;
            if (nextEpisodeBtn) nextEpisodeBtn.disabled = true;
            return;
        }
        
        // Enable/disable previous button
        const hasPrevious = this.currentEpisode > 1 || this.currentSeason > 1;
        if (prevEpisodeBtn) prevEpisodeBtn.disabled = !hasPrevious;
        
        // Enable/disable next button
        const currentSeasonData = this.seasonsData.find(s => s.season_number === this.currentSeason);
        const maxEpisodes = currentSeasonData?.episode_count || 12;
        const hasNext = this.currentEpisode < maxEpisodes || this.currentSeason < this.seasonsData.length;
        if (nextEpisodeBtn) nextEpisodeBtn.disabled = !hasNext;
    }
    
    startTimeTracking() {
        // Simulate time tracking (since we can't access iframe content)
        // In a real implementation, you'd need the embed provider to send messages
        setInterval(() => {
            // Listen for messages from iframe
            window.addEventListener('message', (event) => {
                if (event.data && event.data.type === 'timeupdate') {
                    this.currentTime = event.data.currentTime || 0;
                    this.duration = event.data.duration || 0;
                    this.updateTimeDisplay();
                }
            });
            
            // Fallback: simulate progress for demo purposes
            if (this.isPlaying && this.duration > 0) {
                this.currentTime = Math.min(this.currentTime + 1, this.duration);
                this.updateTimeDisplay();
            }
        }, 1000);
    }
    
    updateTimeDisplay() {
        const currentTimeEl = document.getElementById('currentTime');
        const totalTimeEl = document.getElementById('totalTime');
        const progressBar = document.getElementById('progressBar');
        
        if (currentTimeEl) {
            currentTimeEl.textContent = this.formatTime(this.currentTime);
        }
        
        if (totalTimeEl) {
            totalTimeEl.textContent = this.formatTime(this.duration);
        }
        
        if (progressBar && this.duration > 0) {
            const percent = (this.currentTime / this.duration) * 100;
            progressBar.style.width = `${percent}%`;
        }
    }
    
    formatTime(seconds) {
        if (!seconds || seconds < 0) return '0:00';
        
        const hours = Math.floor(seconds / 3600);
        const minutes = Math.floor((seconds % 3600) / 60);
        const secs = Math.floor(seconds % 60);
        
        if (hours > 0) {
            return `${hours}:${String(minutes).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
        }
        return `${minutes}:${String(secs).padStart(2, '0')}`;
    }

    setupTVControls() {
        if (!this.seasonsData || this.movieData.type !== 'tv') {
            console.log('TV controls not needed:', { seasonsData: !!this.seasonsData, type: this.movieData.type });
            return;
        }
        
        console.log('Setting up TV controls with seasons:', this.seasonsData);
        
        const seasonSelect = document.getElementById('seasonSelect');
        const episodesList = document.getElementById('episodesList');
        
        if (!seasonSelect || !episodesList) {
            console.error('TV control elements not found');
            return;
        }
        
        // Populate season dropdown
        seasonSelect.innerHTML = '';
        this.seasonsData.forEach(season => {
            const option = document.createElement('option');
            option.value = season.season_number;
            option.textContent = season.name || `Season ${season.season_number}`;
            if (season.season_number === this.currentSeason) {
                option.selected = true;
            }
            seasonSelect.appendChild(option);
        });
        
        console.log(`Added ${this.seasonsData.length} seasons to dropdown`);
        
        // Handle season change
        seasonSelect.addEventListener('change', (e) => {
            const newSeason = parseInt(e.target.value);
            console.log(`Season changed from ${this.currentSeason} to ${newSeason}`);
            this.currentSeason = newSeason;
            this.currentEpisode = 1; // Reset to first episode
            this.updateEpisodesList();
            this.updateSubtitle();
            this.updateURL();
            this.loadServer(this.currentServer);
        });
        
        // Load initial episodes
        this.updateEpisodesList();
    }

    updateEpisodesList() {
        const episodesList = document.getElementById('episodesList');
        const currentSeasonData = this.seasonsData.find(s => s.season_number === this.currentSeason);
        
        if (!currentSeasonData) {
            console.error(`No season data found for season ${this.currentSeason}`);
            episodesList.innerHTML = '<div style="padding:20px;text-align:center;color:#aaa;">No episodes found for this season</div>';
            return;
        }
        
        console.log('Updating episodes list for season:', currentSeasonData);
        
        episodesList.innerHTML = '';
        
        // If we have episode data, use it; otherwise create generic episodes
        const episodes = currentSeasonData.episodes && currentSeasonData.episodes.length > 0 
            ? currentSeasonData.episodes 
            : Array.from({length: currentSeasonData.episode_count || 12}, (_, i) => ({
                episode_number: i + 1,
                name: `Episode ${i + 1}`,
                overview: 'No description available.'
            }));
        
        console.log(`Found ${episodes.length} episodes for season ${this.currentSeason}`);
        
        episodes.forEach(episode => {
            const episodeEl = document.createElement('div');
            episodeEl.className = 'episode-item';
            if (episode.episode_number === this.currentEpisode) {
                episodeEl.classList.add('current');
            }
            
            episodeEl.innerHTML = `
                <div class="episode-number">${episode.episode_number}</div>
                <div class="episode-title">
                    <div style="font-weight:600;">${episode.name || `Episode ${episode.episode_number}`}</div>
                    ${episode.overview && episode.overview !== 'No description available.' ? `<div style="font-size:0.8em;color:#aaa;margin-top:2px;">${episode.overview.substring(0, 60)}...</div>` : ''}
                </div>
            `;
            
            episodeEl.addEventListener('click', () => {
                console.log(`Episode clicked: S${this.currentSeason}E${episode.episode_number}`);
                // Remove current class from all episodes
                episodesList.querySelectorAll('.episode-item').forEach(el => el.classList.remove('current'));
                // Add current class to clicked episode
                episodeEl.classList.add('current');
                
                this.currentEpisode = episode.episode_number;
                this.updateURL();
                this.updateSubtitle();
                this.loadServer(this.currentServer);
            });
            
            episodesList.appendChild(episodeEl);
        });
    }

    updateSubtitle() {
        const subtitleEl = document.getElementById('subtitle');
        const contentYear = document.getElementById('contentYear');
        const contentDescription = document.getElementById('contentDescription');
        const year = this.movieData.release_date || this.movieData.first_air_date;
        const yearText = year ? year.split('-')[0] : 'Unknown';
        
        let subtitleText = `${this.movieData.type === 'movie' ? 'Movie' : 'TV Show'} ‚Ä¢ ${yearText}`;
        
        if (this.movieData.type === 'tv') {
            subtitleText += ` ‚Ä¢ S${this.currentSeason}E${this.currentEpisode}`;
            
            // Update content header year with episode info
            if (contentYear) {
                contentYear.textContent = `${yearText} ‚Ä¢ S${this.currentSeason}E${this.currentEpisode}`;
            }
            
            // Try to get episode-specific description
            const currentSeasonData = this.seasonsData.find(s => s.season_number === this.currentSeason);
            if (currentSeasonData && currentSeasonData.episodes) {
                const currentEpisode = currentSeasonData.episodes.find(ep => ep.episode_number === this.currentEpisode);
                if (currentEpisode && currentEpisode.overview && contentDescription) {
                    contentDescription.textContent = currentEpisode.overview;
                } else if (this.movieData.overview && contentDescription) {
                    contentDescription.textContent = this.movieData.overview;
                }
            }
        }
        
        subtitleEl.innerHTML = subtitleText;
    }

    updateURL() {
        const params = new URLSearchParams(window.location.search);
        if (this.movieData.type === 'tv') {
            params.set('season', this.currentSeason);
            params.set('episode', this.currentEpisode);
        }
        const newURL = `${window.location.pathname}?${params.toString()}`;
        window.history.replaceState({}, '', newURL);
    }

    setupServerButtons() {
        const serverDropdownWrapper = document.getElementById('serverDropdownWrapper');
        const serverDropdownBtn = document.getElementById('serverDropdownBtn');
        const serverDropdownMenu = document.getElementById('serverDropdownMenu');
        const currentServerName = document.getElementById('currentServerName');
        const serverItems = document.querySelectorAll('.server-dropdown-item');
        
        // Show the dropdown
        if (serverDropdownWrapper) {
            serverDropdownWrapper.style.display = 'block';
        }
        
        // Toggle dropdown menu
        serverDropdownBtn?.addEventListener('click', (e) => {
            e.stopPropagation();
            serverDropdownBtn.classList.toggle('open');
            serverDropdownMenu.classList.toggle('open');
        });
        
        // Close dropdown when clicking outside
        document.addEventListener('click', (e) => {
            if (!serverDropdownWrapper?.contains(e.target)) {
                serverDropdownBtn?.classList.remove('open');
                serverDropdownMenu?.classList.remove('open');
            }
        });
        
        // Handle server selection from dropdown
        serverItems.forEach(item => {
            item.addEventListener('click', (e) => {
                e.stopPropagation();
                
                // Remove active class from all items
                serverItems.forEach(i => i.classList.remove('active'));
                // Add active class to clicked item
                item.classList.add('active');
                
                // Update button text
                const serverName = item.textContent;
                if (currentServerName) {
                    currentServerName.textContent = serverName;
                }
                
                // Get server domain and load it
                const server = item.dataset.server;
                this.currentServer = server;
                this.loadServer(server);
                
                // Close dropdown
                serverDropdownBtn?.classList.remove('open');
                serverDropdownMenu?.classList.remove('open');
            });
        });
        
        // Also keep the old server buttons functional (hidden but still work if shown)
        const serverButtons = document.querySelectorAll('.server-btn');
        serverButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                serverButtons.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                
                const server = btn.dataset.server;
                this.currentServer = server;
                this.loadServer(server);
            });
        });
    }

    setupQualityControls() {
        const qualitySelect = document.getElementById('qualitySelect');
        const languageSelect = document.getElementById('languageSelect');
        const autoplayCheck = document.getElementById('autoplayCheck');
        
        // Set default quality to auto (which will select best available)
        qualitySelect.value = 'auto';
        this.setOptimalQuality();
        
        // Handle quality change
        qualitySelect.addEventListener('change', (e) => {
            this.preferredQuality = e.target.value;
            console.log('Quality changed to:', this.preferredQuality);
            this.loadServer(this.currentServer);
        });
        
        // Handle language change
        if (languageSelect) {
            languageSelect.addEventListener('change', () => {
                this.loadServer(this.currentServer);
            });
        }
        
        // Handle autoplay change
        if (autoplayCheck) {
            autoplayCheck.addEventListener('change', () => {
                this.loadServer(this.currentServer);
            });
        }
    }

    setOptimalQuality() {
        // Auto-select best quality based on preference: 1080p > 720p > 480p > 360p
        const qualityPreference = ['1080', '720', '480', '360'];
        
        if (this.preferredQuality === 'auto') {
            // Select the highest available quality
            for (const quality of qualityPreference) {
                if (this.availableQualities.includes(quality)) {
                    this.preferredQuality = quality;
                    console.log('Auto-selected quality:', quality + 'p');
                    break;
                }
            }
        }
        
        // Update the select element to show current selection
        const qualitySelect = document.getElementById('qualitySelect');
        if (qualitySelect && this.preferredQuality !== 'auto') {
            // Show which quality was auto-selected
            const autoOption = qualitySelect.querySelector('option[value="auto"]');
            if (autoOption) {
                autoOption.textContent = `Auto (${this.preferredQuality}p Selected)`;
            }
        }
    }

    buildEmbedUrl(server, options = {}) {
        const { language, autoplay = true } = options;
        
        // Special handling for AutoEmbed
        if (server === 'autoembed.cc') {
            return this.buildAutoEmbedUrl(options);
        }
        
        // Special handling for VidLink
        if (server === 'vidlink.pro') {
            return this.buildVidLinkUrl(options);
        }
        
        let baseUrl = `https://${server}/embed`;
        let urlParams = new URLSearchParams();
        
        // Determine if it's movie or TV
        const isTV = this.movieData.type === 'tv';
        baseUrl += isTV ? '/tv' : '/movie';
        
        // Add ID (prefer IMDB if available, fallback to TMDB)
        const id = this.movieData.imdb_id || this.movieData.id;
        
        if (this.movieData.imdb_id) {
            urlParams.set('imdb', id);
        } else {
            urlParams.set('tmdb', id);
        }
        
        // Add optional parameters
        if (language) {
            urlParams.set('ds_lang', language);
        }
        
        if (autoplay !== undefined) {
            urlParams.set('autoplay', autoplay ? '1' : '0');
        }
        
        // Add quality parameter
        if (this.preferredQuality && this.preferredQuality !== 'auto') {
            // Try different quality parameter names that embed services might use
            urlParams.set('quality', this.preferredQuality);
            urlParams.set('res', this.preferredQuality);
            urlParams.set('resolution', this.preferredQuality + 'p');
        }
        
        // For TV shows, add current season/episode
        if (isTV) {
            urlParams.set('s', this.currentSeason);
            urlParams.set('e', this.currentEpisode);
        }
        
        const queryString = urlParams.toString();
        const finalUrl = queryString ? `${baseUrl}?${queryString}` : baseUrl;
        
        console.log(`Built embed URL for ${isTV ? 'TV' : 'Movie'} S${this.currentSeason}E${this.currentEpisode}:`, finalUrl);
        return finalUrl;
    }

    buildAutoEmbedUrl(options = {}) {
        const isTV = this.movieData.type === 'tv';
        let embedUrl;
        
        if (isTV) {
            // Format: https://player.autoembed.cc/embed/tv/{tmdb_id}/{season}/{episode}?server={server number}
            const tmdbId = this.movieData.id;
            embedUrl = `https://player.autoembed.cc/embed/tv/${tmdbId}/${this.currentSeason}/${this.currentEpisode}?server=2`;
        } else {
            // Format: https://player.autoembed.cc/embed/movie/{imdb_id}?server={server number}
            // AutoEmbed requires IMDB ID for movies (format: tt1234567)
            let movieId = this.movieData.imdb_id;
            
            // If no IMDB ID, try to use TMDB ID (though AutoEmbed prefers IMDB for movies)
            if (!movieId) {
                movieId = `tt${this.movieData.id}`; // Fallback - may not work without real IMDB ID
                console.warn('AutoEmbed works best with IMDB IDs for movies. Using TMDB ID as fallback.');
            }
            
            embedUrl = `https://player.autoembed.cc/embed/movie/${movieId}?server=2`;
        }
        
        console.log(`Built AutoEmbed URL for ${isTV ? 'TV' : 'Movie'}:`, embedUrl);
        return embedUrl;
    }

    buildVidLinkUrl(options = {}) {
        const isTV = this.movieData.type === 'tv';
        let embedUrl;
        
        if (isTV) {
            // Format: https://vidlink.pro/tv/{tmdbId}/{season}/{episode}
            const tmdbId = this.movieData.id;
            embedUrl = `https://vidlink.pro/tv/${tmdbId}/${this.currentSeason}/${this.currentEpisode}`;
        } else {
            // Format: https://vidlink.pro/movie/{tmdbId}
            const tmdbId = this.movieData.id;
            embedUrl = `https://vidlink.pro/movie/${tmdbId}`;
        }
        
        console.log(`Built VidLink URL for ${isTV ? 'TV' : 'Movie'}:`, embedUrl);
        return embedUrl;
    }

    loadServer(server) {
        const embedArea = document.getElementById('embedArea');
        const languageSelect = document.getElementById('languageSelect');
        const autoplayCheck = document.getElementById('autoplayCheck');
        
        embedArea.innerHTML = '<div class="loading">üé¨ Loading player...</div>';
        
        try {
            const embedUrl = this.buildEmbedUrl(server, {
                language: languageSelect.value,
                autoplay: autoplayCheck.checked
            });
            
            console.log('Loading embed URL:', embedUrl);
            
            const iframe = document.createElement('iframe');
            iframe.src = embedUrl;
            iframe.width = '100%';
            iframe.height = '500';
            iframe.frameBorder = '0';
            iframe.allowFullscreen = true;
            iframe.allow = 'accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture';
            
            // Handle iframe load
            iframe.onload = () => {
                console.log('Iframe loaded successfully');
            };
            
            iframe.onerror = () => {
                console.error('Failed to load iframe');
                embedArea.innerHTML = `
                    <div class="embed-placeholder">
                        <div style="color:#ff6b6b;">‚ùå Failed to load from ${server}</div>
                        <div style="color:#aaa;font-size:0.9em;margin-top:10px;">Try selecting a different server</div>
                    </div>
                `;
            };
            
            embedArea.innerHTML = '';
            embedArea.appendChild(iframe);
            
            // Store iframe reference
            this.videoIframe = iframe;
            
            // Update episode navigation buttons
            this.updateEpisodeNavButtons();
            
        } catch (error) {
            console.error('Error loading server:', error);
            embedArea.innerHTML = `
                <div class="embed-placeholder">
                    <div style="color:#ff6b6b;">‚ùå Error loading player</div>
                    <div style="color:#aaa;font-size:0.9em;margin-top:10px;">Please try a different server</div>
                </div>
            `;
        }
    }

    showError(message) {
        const titleEl = document.getElementById('title');
        const subtitleEl = document.getElementById('subtitle');
        const embedArea = document.getElementById('embedArea');
        const posterEl = document.getElementById('poster');
        
        titleEl.textContent = 'Error';
        subtitleEl.textContent = message;
        embedArea.innerHTML = `<div class="embed-placeholder">‚ùå ${message}</div>`;
        posterEl.src = 'https://via.placeholder.com/220x320/333/fff?text=Error';
    }
}

// Initialize player when DOM is ready
document.addEventListener('DOMContentLoaded', () => {
    // Add event listeners for controls
    const languageSelect = document.getElementById('languageSelect');
    const autoplayCheck = document.getElementById('autoplayCheck');
    
    let player;
    
    // Initialize player
    player = new VideoPlayer();
    
    // Update player when controls change
    languageSelect?.addEventListener('change', () => {
        if (player && player.currentServer) {
            player.loadServer(player.currentServer);
        }
    });
    
    autoplayCheck?.addEventListener('change', () => {
        if (player && player.currentServer) {
            player.loadServer(player.currentServer);
        }
    });

    // Initialize header search
    class PlayerHeaderSearch {
        constructor() {
            this.searchForm = document.getElementById('headerSearchForm');
            this.searchInput = document.getElementById('headerSearchInput');
            this.searchResults = document.getElementById('headerSearchResults');
            this.debounceTimer = null;
            
            if (this.searchForm && this.searchInput) {
                this.init();
            }
        }

        init() {
            // Handle form submission
            this.searchForm.addEventListener('submit', (e) => {
                e.preventDefault();
                this.performSearch(this.searchInput.value.trim());
            });

            // Handle input with debouncing
            this.searchInput.addEventListener('input', (e) => {
                const query = e.target.value.trim();
                
                clearTimeout(this.debounceTimer);
                
                if (query.length < 2) {
                    this.hideResults();
                    return;
                }

                this.debounceTimer = setTimeout(() => {
                    this.performSearch(query);
                }, 300);
            });

            // Handle clicks outside to close results
            document.addEventListener('click', (e) => {
                if (!this.searchForm.contains(e.target)) {
                    this.hideResults();
                }
            });
        }

        async performSearch(query) {
            if (!query) return;

            const API_KEY = window.TMDB_API_KEY;
            if (!API_KEY) {
                this.showError('Search unavailable');
                return;
            }

            try {
                const url = `https://api.themoviedb.org/3/search/multi?api_key=${API_KEY}&query=${encodeURIComponent(query)}&language=en-US&page=1`;
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                this.displayResults(data.results.slice(0, 8));
                
            } catch (error) {
                console.error('Search failed:', error);
                this.showError('Search failed');
            }
        }

        displayResults(results) {
            if (!results || results.length === 0) {
                this.searchResults.innerHTML = '<div style="padding: 20px; text-align: center; color: #aaa;">No results found</div>';
                this.showResults();
                return;
            }

            const resultsHTML = results.map(item => {
                const title = item.title || item.name || 'Unknown Title';
                const year = item.release_date || item.first_air_date 
                    ? new Date(item.release_date || item.first_air_date).getFullYear()
                    : '';
                const mediaType = item.media_type === 'tv' ? 'TV Show' : 'Movie';
                const posterUrl = item.poster_path 
                    ? `https://image.tmdb.org/t/p/w92${item.poster_path}`
                    : 'https://via.placeholder.com/40x60/333/fff?text=No+Image';

                return `
                    <div class="search-result-item" data-id="${item.id}" data-type="${item.media_type || 'movie'}" data-title="${encodeURIComponent(title)}" style="display: flex; align-items: center; padding: 12px 16px; border-bottom: 1px solid #333; cursor: pointer; transition: background 0.2s ease;">
                        <img src="${posterUrl}" alt="${title}" style="width: 40px; height: 60px; object-fit: cover; border-radius: 4px; margin-right: 12px; background: #222;" loading="lazy">
                        <div style="flex: 1;">
                            <div style="color: #fff; font-weight: 600; margin-bottom: 4px;">${title}</div>
                            <div style="color: #aaa; font-size: 0.8rem;">${mediaType}${year ? ` ‚Ä¢ ${year}` : ''}</div>
                        </div>
                    </div>
                `;
            }).join('');

            this.searchResults.innerHTML = resultsHTML;
            
            // Add click handlers
            this.searchResults.querySelectorAll('.search-result-item').forEach(item => {
                item.addEventListener('mouseover', () => item.style.background = 'rgba(255, 255, 255, 0.1)');
                item.addEventListener('mouseout', () => item.style.background = 'transparent');
                item.addEventListener('click', () => {
                    const id = item.dataset.id;
                    const type = item.dataset.type;
                    const title = decodeURIComponent(item.dataset.title);
                    
                    // Navigate to player
                    window.location.href = `player.html?id=${id}&type=${type}&title=${encodeURIComponent(title)}`;
                });
            });

            this.showResults();
        }

        showError(message) {
            this.searchResults.innerHTML = `<div style="padding: 20px; text-align: center; color: #aaa;">${message}</div>`;
            this.showResults();
        }

        showResults() {
            this.searchResults.style.display = 'block';
        }

        hideResults() {
            this.searchResults.style.display = 'none';
        }
    }

    // Initialize search
    new PlayerHeaderSearch();
});
</script>
</body>
</html>